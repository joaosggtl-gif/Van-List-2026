{% extends "base.html" %}
{% block title %}{{ target_date.strftime('%A, %b %d %Y') }} - Van List 2026{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h4 class="mb-0">
            {{ target_date.strftime('%A, %B %d, %Y') }}
            <span class="badge bg-secondary">Week {{ week_number }}</span>
        </h4>
        <small class="text-muted">
            {{ paired|length }} paired |
            {{ driver_only|length }} driver-only |
            {{ assignments|length }} total |
            {{ total_vans }} active vans |
            {{ total_drivers }} active drivers
        </small>
    </div>
    <div class="d-flex gap-2">
        <a href="/?week={{ week_number }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Back to Week
        </a>
        <a href="/api/export/daily?target_date={{ target_date.isoformat() }}" class="btn btn-success btn-sm">
            <i class="bi bi-download"></i> Export Day XLSX
        </a>
    </div>
</div>

{% if can_edit %}
<!-- Tabbed Assignment Form (operator + admin only) -->
<div class="card mb-3">
    <div class="card-header bg-primary text-white py-2">
        <i class="bi bi-plus-circle"></i> New Assignment
    </div>
    <div class="card-body">
        <ul class="nav nav-tabs mb-3" id="addTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-driver" data-bs-toggle="tab" data-bs-target="#pane-driver" type="button" role="tab">
                    <i class="bi bi-person-plus"></i> Add Driver
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-van" data-bs-toggle="tab" data-bs-target="#pane-van" type="button" role="tab">
                    <i class="bi bi-truck"></i> Add Van
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-full" data-bs-toggle="tab" data-bs-target="#pane-full" type="button" role="tab">
                    <i class="bi bi-link-45deg"></i> Add Full Assignment
                </button>
            </li>
        </ul>
        <div class="tab-content">
            <!-- Add Driver Only -->
            <div class="tab-pane fade show active" id="pane-driver" role="tabpanel">
                <form id="driver-only-form" class="row g-2 align-items-end">
                    <input type="hidden" id="form-date" value="{{ target_date.isoformat() }}">
                    <div class="col-md-6">
                        <label for="do-driver-search" class="form-label form-label-sm">Driver</label>
                        <input type="text" class="form-control form-control-sm" id="do-driver-search"
                               placeholder="Search driver name or ID..." autocomplete="off">
                        <input type="hidden" id="do-driver-id">
                        <div id="do-driver-dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="do-notes" class="form-label form-label-sm">Notes</label>
                        <input type="text" class="form-control form-control-sm" id="do-notes" placeholder="Optional">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-warning btn-sm w-100">
                            <i class="bi bi-person-plus"></i> Add Driver
                        </button>
                    </div>
                </form>
            </div>
            <!-- Add Van Only -->
            <div class="tab-pane fade" id="pane-van" role="tabpanel">
                <form id="van-only-form" class="row g-2 align-items-end">
                    <div class="col-md-6">
                        <label for="vo-van-search" class="form-label form-label-sm">Van</label>
                        <input type="text" class="form-control form-control-sm" id="vo-van-search"
                               placeholder="Search van code..." autocomplete="off">
                        <input type="hidden" id="vo-van-id">
                        <div id="vo-van-dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="vo-notes" class="form-label form-label-sm">Notes</label>
                        <input type="text" class="form-control form-control-sm" id="vo-notes" placeholder="Optional">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-info btn-sm w-100">
                            <i class="bi bi-truck"></i> Add Van
                        </button>
                    </div>
                </form>
            </div>
            <!-- Add Full Assignment -->
            <div class="tab-pane fade" id="pane-full" role="tabpanel">
                <form id="full-form" class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label for="full-driver-search" class="form-label form-label-sm">Driver</label>
                        <input type="text" class="form-control form-control-sm" id="full-driver-search"
                               placeholder="Search driver name or ID..." autocomplete="off">
                        <input type="hidden" id="full-driver-id">
                        <div id="full-driver-dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <div class="col-md-4">
                        <label for="full-van-search" class="form-label form-label-sm">Van</label>
                        <input type="text" class="form-control form-control-sm" id="full-van-search"
                               placeholder="Search van code..." autocomplete="off">
                        <input type="hidden" id="full-van-id">
                        <div id="full-van-dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <div class="col-md-2">
                        <label for="full-notes" class="form-label form-label-sm">Notes</label>
                        <input type="text" class="form-control form-control-sm" id="full-notes" placeholder="Optional">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="bi bi-link-45deg"></i> Assign
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div id="form-alert" class="mt-2" style="display:none;"></div>
    </div>
</div>

{% endif %}

<!-- Paired Assignments -->
<div class="card mb-3">
    <div class="card-header bg-success text-white py-2 d-flex justify-content-between align-items-center">
        <span><i class="bi bi-link-45deg"></i> Paired Assignments</span>
        <span class="badge bg-light text-success">{{ paired|length }}</span>
    </div>
    <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Driver ID</th>
                    <th>Driver Name</th>
                    <th>Van (Plate)</th>
                    <th>Op. Status</th>
                    <th>Notes</th>
                    <th>Created</th>
                    {% if can_edit %}<th>Actions</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for a in paired %}
                <tr id="row-{{ a.id }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ a.driver.employee_id }}</td>
                    <td>{{ a.driver.name }}</td>
                    <td><strong>{{ a.van.code }}</strong></td>
                    <td>
                        {% if a.van.operational_status == 'OPERATIONAL' %}
                            <span class="badge bg-success">OPERATIONAL</span>
                        {% elif a.van.operational_status == 'GROUNDED' %}
                            <span class="badge bg-danger">GROUNDED</span>
                        {% elif a.van.operational_status %}
                            <span class="badge bg-secondary">{{ a.van.operational_status }}</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if can_edit %}
                        <input type="text" class="form-control form-control-sm notes-inline"
                               value="{{ a.notes or '' }}"
                               data-assignment-id="{{ a.id }}"
                               data-driver-id="{{ a.driver_id }}"
                               data-van-id="{{ a.van_id }}"
                               placeholder="Add notes..."
                               style="min-width:120px;">
                        {% else %}
                        {{ a.notes or '' }}
                        {% endif %}
                    </td>
                    <td><small>{{ a.created_at.strftime('%H:%M') }}</small></td>
                    {% if can_edit %}
                    <td>
                        <button class="btn btn-outline-secondary btn-sm py-0 px-1" title="Unpair"
                                onclick="unpairAssignment({{ a.id }})">
                            <i class="bi bi-scissors"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm py-0 px-1" title="Delete"
                                onclick="deleteAssignment({{ a.id }})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% if not paired %}
                <tr>
                    <td colspan="{% if can_edit %}8{% else %}7{% endif %}" class="text-center text-muted py-2">
                        No paired assignments yet.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Drivers Awaiting Van -->
<div class="card mb-3">
    <div class="card-header bg-warning py-2 d-flex justify-content-between align-items-center">
        <span><i class="bi bi-person"></i> Drivers Awaiting Van</span>
        <div class="d-flex align-items-center gap-2">
            {% if can_edit and driver_only %}
            <button class="btn btn-danger btn-sm py-0 px-2" onclick="removeSelectedDrivers()" id="btn-remove-selected" style="display:none;">
                <i class="bi bi-trash"></i> Remove Selected
            </button>
            {% endif %}
            <span class="badge bg-dark">{{ driver_only|length }}</span>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    {% if can_edit %}<th style="width:30px;"><input type="checkbox" id="select-all-drivers" onchange="toggleAllDriverCheckboxes(this)"></th>{% endif %}
                    <th>#</th>
                    <th>Driver ID</th>
                    <th>Driver Name</th>
                    <th>Notes</th>
                    <th>Created</th>
                    {% if can_edit %}<th>Pair with Van</th><th>Actions</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for a in driver_only %}
                <tr id="row-{{ a.id }}">
                    {% if can_edit %}<td><input type="checkbox" class="driver-checkbox" value="{{ a.id }}" onchange="updateRemoveSelectedBtn()"></td>{% endif %}
                    <td>{{ loop.index }}</td>
                    <td>{{ a.driver.employee_id }}</td>
                    <td>{{ a.driver.name }}</td>
                    <td>{{ a.notes or '' }}</td>
                    <td><small>{{ a.created_at.strftime('%H:%M') }}</small></td>
                    {% if can_edit %}
                    <td style="position:relative;">
                        <input type="text" class="form-control form-control-sm pair-van-search"
                               id="pair-van-search-{{ a.id }}"
                               data-assignment-id="{{ a.id }}"
                               data-driver-id="{{ a.driver_id }}"
                               placeholder="Type van code..."
                               autocomplete="off"
                               style="min-width:180px;">
                        <input type="hidden" id="pair-van-id-{{ a.id }}">
                        <div id="pair-van-dropdown-{{ a.id }}" class="autocomplete-dropdown"></div>
                    </td>
                    <td>
                        <button class="btn btn-outline-danger btn-sm py-0 px-1" title="Delete"
                                onclick="deleteAssignment({{ a.id }})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% if not driver_only %}
                <tr>
                    <td colspan="{% if can_edit %}8{% else %}5{% endif %}" class="text-center text-muted py-2">
                        No drivers awaiting van.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{% if can_edit %}
<!-- Bulk Upload Section -->
<div class="card mb-3">
    <div class="card-header bg-secondary text-white py-2">
        <i class="bi bi-upload"></i> Bulk Upload for {{ target_date.strftime('%b %d') }}
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <form id="bulk-drivers-form" enctype="multipart/form-data">
                    <label class="form-label form-label-sm"><i class="bi bi-people"></i> Upload Drivers (XLSX/CSV)</label>
                    <div class="input-group input-group-sm">
                        <input type="file" class="form-control form-control-sm" id="bulk-drivers-file" accept=".xlsx,.csv">
                        <button type="submit" class="btn btn-warning btn-sm">Upload Drivers</button>
                    </div>
                </form>
            </div>
            <div class="col-md-6">
                <form id="bulk-vans-form" enctype="multipart/form-data">
                    <label class="form-label form-label-sm"><i class="bi bi-truck"></i> Upload Vans (XLSX/CSV)</label>
                    <div class="input-group input-group-sm">
                        <input type="file" class="form-control form-control-sm" id="bulk-vans-file" accept=".xlsx,.csv">
                        <button type="submit" class="btn btn-info btn-sm">Upload Vans</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="bulk-alert" class="mt-2" style="display:none;"></div>
    </div>
</div>

<!-- Unrecognized Names (shown after driver_route upload) -->
<div id="unrecognized-card" class="card mb-3 border-danger" style="display:none;">
    <div class="card-header bg-danger text-white py-2 d-flex justify-content-between align-items-center">
        <span><i class="bi bi-exclamation-triangle"></i> Unrecognized Names</span>
        <span class="badge bg-light text-danger" id="unrecognized-count">0</span>
    </div>
    <div class="card-body p-0">
        <p class="text-muted small px-3 pt-2 mb-1">These names from the uploaded file did not match any registered driver.</p>
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Name in File</th>
                    </tr>
                </thead>
                <tbody id="unrecognized-body"></tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
const CURRENT_DATE = '{{ target_date.isoformat() }}';
const CAN_EDIT = {{ 'true' if can_edit else 'false' }};

function showAlert(msg, type, containerId) {
    const alertDiv = document.getElementById(containerId || 'form-alert');
    alertDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show py-1 mb-0" role="alert">
        ${msg}
        <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert"></button>
    </div>`;
    alertDiv.style.display = 'block';
}

async function deleteAssignment(id) {
    if (!confirm('Remove this assignment?')) return;
    try {
        const resp = await fetch(`/api/assignments/${id}`, {method: 'DELETE'});
        if (resp.status === 401) { window.location.href = '/login'; return; }
        if (resp.status === 403) { alert('Permission denied.'); return; }
        if (resp.ok) {
            window.location.reload();
        } else {
            const data = await resp.json();
            alert(data.detail || 'Error deleting');
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
}

async function saveNotes(input) {
    const id = input.dataset.assignmentId;
    const driverId = input.dataset.driverId;
    const vanId = input.dataset.vanId;
    const notes = input.value.trim() || null;
    try {
        const resp = await fetch(`/api/assignments/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                assignment_date: CURRENT_DATE,
                driver_id: driverId ? parseInt(driverId) : null,
                van_id: vanId ? parseInt(vanId) : null,
                notes: notes,
            }),
        });
        if (resp.status === 401) { window.location.href = '/login'; return; }
        if (resp.status === 403) { alert('Permission denied.'); return; }
        if (resp.ok) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            setTimeout(() => input.classList.remove('is-valid'), 1500);
        } else {
            const data = await resp.json();
            input.classList.add('is-invalid');
            alert(data.detail || 'Error saving notes');
        }
    } catch (err) {
        input.classList.add('is-invalid');
        alert('Network error: ' + err.message);
    }
}

document.querySelectorAll('.notes-inline').forEach(input => {
    let original = input.value;
    input.addEventListener('blur', () => {
        if (input.value !== original) { saveNotes(input); original = input.value; }
    });
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    });
});

async function unpairAssignment(id) {
    if (!confirm('Unpair this assignment into separate driver and van entries?')) return;
    try {
        const resp = await fetch(`/api/assignments/${id}/unpair`, {method: 'POST'});
        if (resp.status === 401) { window.location.href = '/login'; return; }
        if (resp.status === 403) { alert('Permission denied.'); return; }
        if (resp.ok) {
            window.location.reload();
        } else {
            const data = await resp.json();
            alert(data.detail || 'Error unpairing');
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
}

function toggleAllDriverCheckboxes(source) {
    document.querySelectorAll('.driver-checkbox').forEach(cb => { cb.checked = source.checked; });
    updateRemoveSelectedBtn();
}

function updateRemoveSelectedBtn() {
    const btn = document.getElementById('btn-remove-selected');
    if (!btn) return;
    const checked = document.querySelectorAll('.driver-checkbox:checked').length;
    btn.style.display = checked > 0 ? 'inline-block' : 'none';
    btn.innerHTML = `<i class="bi bi-trash"></i> Remove Selected (${checked})`;
}

async function removeSelectedDrivers() {
    const ids = Array.from(document.querySelectorAll('.driver-checkbox:checked')).map(cb => parseInt(cb.value));
    if (ids.length === 0) return;
    if (!confirm(`Remove ${ids.length} selected driver assignment(s)?`)) return;
    try {
        const results = await Promise.all(ids.map(id =>
            fetch(`/api/assignments/${id}`, {method: 'DELETE'})
        ));
        const unauthorized = results.find(r => r.status === 401);
        if (unauthorized) { window.location.href = '/login'; return; }
        const forbidden = results.find(r => r.status === 403);
        if (forbidden) { alert('Permission denied.'); return; }
        const failed = results.filter(r => !r.ok);
        if (failed.length > 0) {
            alert(`${ids.length - failed.length} removed, ${failed.length} failed.`);
        }
        window.location.reload();
    } catch (err) {
        alert('Network error: ' + err.message);
    }
}

async function assignVanToDriver(driverAssignmentId, driverId, vanId) {
    if (!vanId) return;
    try {
        // Update the driver-only assignment to include the selected van
        const resp = await fetch(`/api/assignments/${driverAssignmentId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                assignment_date: CURRENT_DATE,
                driver_id: driverId,
                van_id: parseInt(vanId),
            }),
        });
        if (resp.status === 401) { window.location.href = '/login'; return; }
        if (resp.status === 403) { alert('Permission denied.'); return; }
        if (resp.ok) {
            window.location.reload();
        } else {
            const data = await resp.json();
            alert(data.detail || 'Error assigning van');
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
}

if (CAN_EDIT) {
    // --- Autocomplete logic ---
    function setupAutocomplete(inputId, hiddenId, dropdownId, apiUrl) {
        const input = document.getElementById(inputId);
        const hidden = document.getElementById(hiddenId);
        const dropdown = document.getElementById(dropdownId);
        let debounceTimer;
        let activeIndex = -1;
        let currentItems = [];

        function selectItem(item) {
            hidden.value = item.id;
            input.value = item.code || `${item.employee_id} - ${item.name}`;
            input.classList.add('is-valid');
            dropdown.style.display = 'none';
            activeIndex = -1;
        }

        function updateActiveItem() {
            const items = dropdown.querySelectorAll('.autocomplete-item:not(.text-muted)');
            items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
            if (activeIndex >= 0 && items[activeIndex]) {
                items[activeIndex].scrollIntoView({block: 'nearest'});
            }
        }

        input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            hidden.value = '';
            input.classList.remove('is-valid');
            activeIndex = -1;
            debounceTimer = setTimeout(() => fetchResults(input.value), 200);
        });

        input.addEventListener('keydown', (e) => {
            const items = dropdown.querySelectorAll('.autocomplete-item:not(.text-muted)');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (dropdown.style.display === 'none') { fetchResults(input.value); return; }
                activeIndex = Math.min(activeIndex + 1, items.length - 1);
                updateActiveItem();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = Math.max(activeIndex - 1, 0);
                updateActiveItem();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (hidden.value) {
                    // Already selected, submit the form
                    input.closest('form').dispatchEvent(new Event('submit', {cancelable: true}));
                    return;
                }
                if (dropdown.style.display !== 'none' && currentItems.length > 0) {
                    const idx = activeIndex >= 0 ? activeIndex : 0;
                    if (currentItems[idx]) selectItem(currentItems[idx]);
                }
            } else if (e.key === 'Escape') {
                dropdown.style.display = 'none';
                activeIndex = -1;
            }
        });

        input.addEventListener('focus', () => {
            if (!hidden.value) fetchResults(input.value);
        });

        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
                activeIndex = -1;
            }
        });

        function fetchResults(query) {
            const url = `${apiUrl}?assignment_date=${CURRENT_DATE}&q=${encodeURIComponent(query)}`;
            fetch(url)
                .then(r => {
                    if (r.status === 401) { window.location.href = '/login'; return []; }
                    return r.json();
                })
                .then(items => {
                    if (!items) return;
                    currentItems = items;
                    activeIndex = -1;
                    dropdown.innerHTML = '';
                    if (items.length === 0) {
                        dropdown.innerHTML = '<div class="autocomplete-item text-muted">No results</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    items.forEach((item, idx) => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        if (item.code) {
                            let label = item.code;
                            if (item.description) label += ` - ${item.description}`;
                            if (item.operational_status) {
                                const cls = item.operational_status === 'OPERATIONAL' ? 'bg-success' : 'bg-danger';
                                div.innerHTML = `${label} <span class="badge ${cls}" style="font-size:0.65rem">${item.operational_status}</span>`;
                            } else {
                                div.textContent = label;
                            }
                        } else {
                            div.textContent = `${item.employee_id} - ${item.name}`;
                        }
                        div.addEventListener('click', () => selectItem(item));
                        div.addEventListener('mouseenter', () => {
                            activeIndex = idx;
                            updateActiveItem();
                        });
                        dropdown.appendChild(div);
                    });
                    dropdown.style.display = 'block';
                });
        }
    }

    // Driver-only form autocomplete
    setupAutocomplete('do-driver-search', 'do-driver-id', 'do-driver-dropdown', '/api/assignments/available-drivers');

    // Van-only form autocomplete
    setupAutocomplete('vo-van-search', 'vo-van-id', 'vo-van-dropdown', '/api/assignments/available-vans');

    // Full assignment form autocomplete
    setupAutocomplete('full-driver-search', 'full-driver-id', 'full-driver-dropdown', '/api/assignments/available-drivers');
    setupAutocomplete('full-van-search', 'full-van-id', 'full-van-dropdown', '/api/assignments/available-vans');

    // --- Pair van autocomplete (Drivers Awaiting Van section) ---
    const assignedVanIds = new Set({{ assigned_van_ids | list | tojson }});

    function setupPairVanAutocomplete(input) {
        const assignmentId = parseInt(input.dataset.assignmentId);
        const driverId = parseInt(input.dataset.driverId);
        const hidden = document.getElementById(`pair-van-id-${assignmentId}`);
        const dropdown = document.getElementById(`pair-van-dropdown-${assignmentId}`);
        let debounceTimer;
        let activeIndex = -1;
        let currentItems = [];

        function selectItem(item) {
            hidden.value = item.id;
            input.value = item.code + (item.description ? ` - ${item.description}` : '');
            input.classList.add('is-valid');
            dropdown.style.display = 'none';
            activeIndex = -1;
            assignVanToDriver(assignmentId, driverId, item.id);
        }

        function updateActiveItem() {
            const items = dropdown.querySelectorAll('.autocomplete-item:not(.text-muted)');
            items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
            if (activeIndex >= 0 && items[activeIndex]) {
                items[activeIndex].scrollIntoView({block: 'nearest'});
            }
        }

        function fetchResults(query) {
            fetch(`/api/vans/search?q=${encodeURIComponent(query)}`)
                .then(r => {
                    if (r.status === 401) { window.location.href = '/login'; return []; }
                    return r.json();
                })
                .then(items => {
                    if (!items) return;
                    currentItems = items;
                    activeIndex = -1;
                    dropdown.innerHTML = '';
                    if (items.length === 0) {
                        dropdown.innerHTML = '<div class="autocomplete-item text-muted">No results</div>';
                        dropdown.style.display = 'block';
                        return;
                    }
                    items.forEach((item, idx) => {
                        const div = document.createElement('div');
                        const isAssigned = assignedVanIds.has(item.id);
                        div.className = 'autocomplete-item' + (isAssigned ? ' text-muted' : '');
                        let label = item.code;
                        if (item.description) label += ` - ${item.description}`;
                        if (item.operational_status) {
                            const cls = item.operational_status === 'OPERATIONAL' ? 'bg-success' : 'bg-danger';
                            label += ` <span class="badge ${cls}" style="font-size:0.65rem">${item.operational_status}</span>`;
                        }
                        if (isAssigned) label += ' <em>(assigned)</em>';
                        div.innerHTML = label;
                        if (!isAssigned) {
                            div.addEventListener('click', () => selectItem(item));
                            div.addEventListener('mouseenter', () => { activeIndex = idx; updateActiveItem(); });
                        } else {
                            div.style.cursor = 'not-allowed';
                        }
                        dropdown.appendChild(div);
                    });
                    dropdown.style.display = 'block';
                });
        }

        input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            hidden.value = '';
            input.classList.remove('is-valid');
            activeIndex = -1;
            debounceTimer = setTimeout(() => fetchResults(input.value.trim()), 200);
        });

        input.addEventListener('focus', () => {
            if (!hidden.value) fetchResults(input.value.trim());
        });

        input.addEventListener('keydown', (e) => {
            const items = dropdown.querySelectorAll('.autocomplete-item:not(.text-muted)');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (dropdown.style.display === 'none') { fetchResults(input.value.trim()); return; }
                activeIndex = Math.min(activeIndex + 1, items.length - 1);
                updateActiveItem();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = Math.max(activeIndex - 1, 0);
                updateActiveItem();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (dropdown.style.display !== 'none') {
                    const selectableItems = currentItems.filter(i => !assignedVanIds.has(i.id));
                    if (selectableItems.length > 0) {
                        const idx = activeIndex >= 0 ? activeIndex : 0;
                        const target = currentItems[idx];
                        if (target && !assignedVanIds.has(target.id)) selectItem(target);
                    }
                }
            } else if (e.key === 'Escape') {
                dropdown.style.display = 'none';
                activeIndex = -1;
            }
        });

        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
                activeIndex = -1;
            }
        });
    }

    document.querySelectorAll('.pair-van-search').forEach(setupPairVanAutocomplete);

    // --- Driver-only submit ---
    document.getElementById('driver-only-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const driverId = document.getElementById('do-driver-id').value;
        const notes = document.getElementById('do-notes').value;
        if (!driverId) { showAlert('Please select a driver from the dropdown.', 'warning'); return; }
        try {
            const resp = await fetch('/api/assignments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ assignment_date: CURRENT_DATE, driver_id: parseInt(driverId), notes: notes || null }),
            });
            if (resp.status === 401) { window.location.href = '/login'; return; }
            if (resp.status === 403) { showAlert('Permission denied.', 'danger'); return; }
            const data = await resp.json();
            if (!resp.ok) { showAlert(data.detail || 'Error', 'danger'); return; }
            window.location.reload();
        } catch (err) { showAlert('Network error: ' + err.message, 'danger'); }
    });

    // --- Van-only submit ---
    document.getElementById('van-only-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const vanId = document.getElementById('vo-van-id').value;
        const notes = document.getElementById('vo-notes').value;
        if (!vanId) { showAlert('Please select a van from the dropdown.', 'warning'); return; }
        try {
            const resp = await fetch('/api/assignments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ assignment_date: CURRENT_DATE, van_id: parseInt(vanId), notes: notes || null }),
            });
            if (resp.status === 401) { window.location.href = '/login'; return; }
            if (resp.status === 403) { showAlert('Permission denied.', 'danger'); return; }
            const data = await resp.json();
            if (!resp.ok) { showAlert(data.detail || 'Error', 'danger'); return; }
            window.location.reload();
        } catch (err) { showAlert('Network error: ' + err.message, 'danger'); }
    });

    // --- Full assignment submit ---
    document.getElementById('full-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const driverId = document.getElementById('full-driver-id').value;
        const vanId = document.getElementById('full-van-id').value;
        const notes = document.getElementById('full-notes').value;
        if (!driverId) { showAlert('Please select a driver from the dropdown.', 'warning'); return; }
        if (!vanId) { showAlert('Please select a van from the dropdown.', 'warning'); return; }
        try {
            const resp = await fetch('/api/assignments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    assignment_date: CURRENT_DATE,
                    driver_id: parseInt(driverId),
                    van_id: parseInt(vanId),
                    notes: notes || null,
                }),
            });
            if (resp.status === 401) { window.location.href = '/login'; return; }
            if (resp.status === 403) { showAlert('Permission denied.', 'danger'); return; }
            const data = await resp.json();
            if (!resp.ok) { showAlert(data.detail || 'Error', 'danger'); return; }
            window.location.reload();
        } catch (err) { showAlert('Network error: ' + err.message, 'danger'); }
    });

    function showUnrecognizedNames(names) {
        const card = document.getElementById('unrecognized-card');
        const body = document.getElementById('unrecognized-body');
        const count = document.getElementById('unrecognized-count');
        body.innerHTML = '';
        names.forEach((name, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${i + 1}</td><td>${name}</td>`;
            body.appendChild(tr);
        });
        count.textContent = names.length;
        card.style.display = 'block';
        card.scrollIntoView({behavior: 'smooth', block: 'nearest'});
    }

    // --- Bulk upload forms ---
    document.getElementById('bulk-drivers-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('bulk-drivers-file');
        if (!fileInput.files.length) { showAlert('Please select a file.', 'warning', 'bulk-alert'); return; }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        try {
            const resp = await fetch(`/api/assignments/bulk-upload-drivers?assignment_date=${CURRENT_DATE}`, {
                method: 'POST', body: formData,
            });
            if (resp.status === 401) { window.location.href = '/login'; return; }
            if (resp.status === 403) { showAlert('Permission denied.', 'danger', 'bulk-alert'); return; }
            const data = await resp.json();
            if (!resp.ok) { showAlert(data.detail || 'Error uploading', 'danger', 'bulk-alert'); return; }
            let msg = `Drivers uploaded: ${data.assignments_created} created, ${data.assignments_skipped} already assigned.`;
            const notFound = data.import_result && data.import_result.not_found ? data.import_result.not_found : [];
            if (notFound.length > 0) {
                msg += ` <strong>${notFound.length} not recognized.</strong>`;
                showUnrecognizedNames(notFound);
            }
            showAlert(msg, notFound.length > 0 ? 'warning' : 'success', 'bulk-alert');
            setTimeout(() => window.location.reload(), 1500);
        } catch (err) { showAlert('Network error: ' + err.message, 'danger', 'bulk-alert'); }
    });

    document.getElementById('bulk-vans-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('bulk-vans-file');
        if (!fileInput.files.length) { showAlert('Please select a file.', 'warning', 'bulk-alert'); return; }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        try {
            const resp = await fetch(`/api/assignments/bulk-upload-vans?assignment_date=${CURRENT_DATE}`, {
                method: 'POST', body: formData,
            });
            if (resp.status === 401) { window.location.href = '/login'; return; }
            if (resp.status === 403) { showAlert('Permission denied.', 'danger', 'bulk-alert'); return; }
            const data = await resp.json();
            if (!resp.ok) { showAlert(data.detail || 'Error uploading', 'danger', 'bulk-alert'); return; }
            showAlert(`Vans uploaded: ${data.assignments_created} created, ${data.assignments_skipped} already assigned.`, 'success', 'bulk-alert');
            setTimeout(() => window.location.reload(), 1500);
        } catch (err) { showAlert('Network error: ' + err.message, 'danger', 'bulk-alert'); }
    });
}
</script>
{% endblock %}
