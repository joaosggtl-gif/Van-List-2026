{% extends "base.html" %}
{% block title %}User Management - Van List 2026{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-people"></i> User Management</h4>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createUserModal">
        <i class="bi bi-person-plus"></i> New User
    </button>
</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr class="{% if not u.active %}table-secondary{% endif %}">
                    <td><strong>{{ u.username }}</strong></td>
                    <td>{{ u.full_name }}</td>
                    <td>
                        <span class="badge bg-{% if u.role == 'admin' %}danger{% elif u.role == 'operator' %}primary{% else %}secondary{% endif %}">
                            {{ u.role }}
                        </span>
                    </td>
                    <td>
                        {% if u.active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                    </td>
                    <td><small>{{ u.created_at.strftime('%Y-%m-%d') }}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary py-0 px-1" onclick="editUser({{ u.id }}, '{{ u.full_name }}', '{{ u.role }}', {{ 'true' if u.active else 'false' }})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-warning py-0 px-1" onclick="resetPassword({{ u.id }}, '{{ u.username }}')">
                                <i class="bi bi-key"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-user-form">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control form-control-sm" id="new-username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control form-control-sm" id="new-fullname" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control form-control-sm" id="new-password" required minlength="6">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select form-select-sm" id="new-role">
                            <option value="readonly">Read-only</option>
                            <option value="operator">Operator</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div id="create-alert"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-user-id">
                <div class="mb-3">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control form-control-sm" id="edit-fullname">
                </div>
                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select class="form-select form-select-sm" id="edit-role">
                        <option value="readonly">Read-only</option>
                        <option value="operator">Operator</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="edit-active">
                        <label class="form-check-label">Active</label>
                    </div>
                </div>
                <div id="edit-alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="saveUser()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
async function createUser() {
    const alertDiv = document.getElementById('create-alert');
    const resp = await fetch('/api/auth/users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            username: document.getElementById('new-username').value,
            full_name: document.getElementById('new-fullname').value,
            password: document.getElementById('new-password').value,
            role: document.getElementById('new-role').value,
        }),
    });
    if (resp.status === 401) { window.location.href = '/login'; return; }
    const data = await resp.json();
    if (!resp.ok) {
        alertDiv.innerHTML = `<div class="alert alert-danger py-1 small">${data.detail}</div>`;
        return;
    }
    window.location.reload();
}

function editUser(id, fullName, role, active) {
    document.getElementById('edit-user-id').value = id;
    document.getElementById('edit-fullname').value = fullName;
    document.getElementById('edit-role').value = role;
    document.getElementById('edit-active').checked = active;
    new bootstrap.Modal(document.getElementById('editUserModal')).show();
}

async function saveUser() {
    const id = document.getElementById('edit-user-id').value;
    const alertDiv = document.getElementById('edit-alert');
    const resp = await fetch(`/api/auth/users/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            full_name: document.getElementById('edit-fullname').value,
            role: document.getElementById('edit-role').value,
            active: document.getElementById('edit-active').checked,
        }),
    });
    if (resp.status === 401) { window.location.href = '/login'; return; }
    const data = await resp.json();
    if (!resp.ok) {
        alertDiv.innerHTML = `<div class="alert alert-danger py-1 small">${data.detail}</div>`;
        return;
    }
    window.location.reload();
}

async function resetPassword(id, username) {
    const newPwd = prompt(`Enter new password for "${username}" (min 6 chars):`);
    if (!newPwd || newPwd.length < 6) {
        if (newPwd !== null) alert('Password must be at least 6 characters.');
        return;
    }
    const resp = await fetch(`/api/auth/users/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ password: newPwd }),
    });
    if (resp.ok) {
        alert('Password updated successfully.');
    } else {
        const data = await resp.json();
        alert(data.detail || 'Error updating password.');
    }
}
</script>
{% endblock %}
