{% extends "base.html" %}
{% block title %}Week {{ current_week }} - Van List 2026{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h4 class="mb-0">
            Week {{ current_week }}
            <small class="text-muted">{{ week_start.strftime('%b %d') }} - {{ week_end.strftime('%b %d, %Y') }}</small>
            {% if is_historical %}
            <span class="badge bg-info">Historical</span>
            {% endif %}
        </h4>
        <small class="text-muted">{{ total_vans }} vans{% if not is_historical %} | {{ total_drivers }} active drivers{% endif %}</small>
    </div>
    <div class="d-flex gap-2 align-items-center">
        <a href="/?week={{ current_week - 1 }}" class="btn btn-outline-secondary btn-sm" {% if current_week <= min_week %}disabled{% endif %}>
            <i class="bi bi-chevron-left"></i> Prev
        </a>
        <a href="/" class="btn btn-outline-primary btn-sm">Today</a>
        <a href="/?week={{ current_week + 1 }}" class="btn btn-outline-secondary btn-sm">
            Next <i class="bi bi-chevron-right"></i>
        </a>
        {% if not is_historical %}
        <div class="btn-group">
            <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-download"></i> Export XLSX
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                {% for day in days %}
                <li><a class="dropdown-item" href="/api/export/daily-simple?target_date={{ day.isoformat() }}">{{ day.strftime('%A %d/%m') }}</a></li>
                {% endfor %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/api/export/weekly?week={{ current_week }}"><i class="bi bi-table"></i> Full Week</a></li>
            </ul>
        </div>
        {% if can_edit %}
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadDriversModal">
            <i class="bi bi-upload"></i> Upload Drivers
        </button>
        {% endif %}
        {% endif %}
    </div>
</div>

{# Day stats row #}
<div class="d-flex gap-2 mb-2 flex-wrap">
    {% for day in days %}
    {% set day_iso = day.isoformat() %}
    {% set dc = counts_by_date[day_iso] %}
    <span class="badge {% if day == today %}bg-primary{% else %}bg-secondary{% endif %}">
        {{ day.strftime('%a') }}: {{ dc.paired }}/{{ dc.total }}
    </span>
    {% endfor %}
</div>

{% if is_historical %}
{# ===== HISTORICAL VIEW (read-only) ===== #}
<div class="van-grid-wrapper">
    <table class="table table-bordered table-sm van-grid-table mb-0">
        <thead class="sticky-top">
            <tr>
                <th class="col-van">Van</th>
                {% for day in days %}
                <th class="col-day">
                    <div>{{ day.strftime('%A') }}</div>
                    <small>{{ day.strftime('%d/%m') }}</small>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for van_reg in hist_van_regs %}
            {% set van_grid = hist_grid[van_reg] %}
            <tr>
                <td class="col-van">
                    <strong>{{ van_reg }}</strong>
                </td>
                {% for day in days %}
                {% set day_iso = day.isoformat() %}
                {% set cell = van_grid[day_iso] %}
                <td class="col-day cell-driver">
                    {% if cell and cell.is_vor %}
                        <span class="text-danger fw-bold">VOR</span>
                    {% elif cell and cell.driver_name %}
                        <span class="driver-name">{{ cell.driver_name }}</span>
                    {% else %}
                        <span class="text-muted">Free</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
{# ===== CURRENT VIEW (editable) ===== #}
{% if can_edit %}
<div class="d-flex align-items-center gap-2 mb-1">
    <label class="form-check-label" style="font-size:0.78rem;">
        <input type="checkbox" class="form-check-input" id="gridSelectAll" onchange="toggleAllGrid(this)"> Select All
    </label>
    <button id="btn-remove-grid" class="btn btn-danger btn-sm py-0 px-2" style="display:none; font-size:0.75rem;" onclick="removeSelectedGrid()">
        <i class="bi bi-trash"></i> Remove Selected
    </button>
</div>
{% endif %}

<div class="van-grid-wrapper">
    <table class="table table-bordered table-sm van-grid-table mb-0">
        <thead class="sticky-top">
            <tr>
                <th class="col-preassign">Preassign</th>
                <th class="col-van">Van</th>
                {% for day in days %}
                {% set is_today = day == today %}
                <th class="col-day {% if is_today %}col-today{% endif %}">
                    <div>{{ day.strftime('%A') }}</div>
                    <small>{{ day.strftime('%d/%m') }}</small>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for van in all_vans %}
            {% set van_grid = grid[van.id] %}
            {% set is_grounded = van.operational_status == 'GROUNDED' %}
            <tr class="{% if is_grounded %}row-grounded{% endif %}">
                <td class="col-preassign cell-preassign"
                    data-van-id="{{ van.id }}"
                    {% if preassign_by_van.get(van.id) %}
                    data-preassign-id="{{ preassign_by_van[van.id].id }}"
                    data-preassign-name="{{ preassign_by_van[van.id].name | short_name }}"
                    {% endif %}>
                    {% if can_edit %}
                    <span class="preassign-link" style="cursor:pointer">
                        {{ (preassign_by_van.get(van.id, {}).get('name', '') | short_name) or '—' }}
                    </span>
                    {% else %}
                    {{ preassign_by_van.get(van.id, {}).get('name', '') | short_name }}
                    {% endif %}
                </td>
                <td class="col-van cell-van {% if is_grounded %}text-danger{% endif %}"
                    data-van-id="{{ van.id }}" data-van-code="{{ van.code }}" data-van-status="{{ van.operational_status or 'OPERATIONAL' }}">
                    {% if can_edit %}
                    <span class="van-code-link" style="cursor:pointer">
                        <strong>{{ van.code }}</strong>
                    </span>
                    {% else %}
                    <strong>{{ van.code }}</strong>
                    {% endif %}
                    {% if is_grounded %}
                    <i class="bi bi-exclamation-triangle-fill text-danger" title="GROUNDED"></i>
                    {% endif %}
                </td>
                {% for day in days %}
                {% set day_iso = day.isoformat() %}
                {% set assignment = van_grid[day_iso] %}
                {% set is_today = day == today %}
                <td class="col-day cell-driver {% if is_today %}col-today{% endif %} {% if can_edit %}cell-editable{% endif %}"
                    data-van-id="{{ van.id }}"
                    data-van-code="{{ van.code }}"
                    data-date="{{ day_iso }}"
                    {% if assignment %}
                    data-assignment-id="{{ assignment.id }}"
                    data-driver-id="{{ assignment.driver_id or '' }}"
                    data-driver-name="{{ (assignment.driver.name if assignment.driver else '') | short_name }}"
                    {% endif %}
                >
                    {% if is_grounded and not assignment %}
                        <span class="text-danger fw-bold">VOR</span>
                    {% elif assignment and assignment.driver %}
                        {% if can_edit %}
                        <input type="checkbox" class="form-check-input grid-checkbox" value="{{ assignment.id }}" onchange="updateRemoveGridBtn()" onclick="event.stopPropagation()" style="margin:0 3px 0 0; vertical-align:middle; flex-shrink:0;">
                        {% endif %}
                        <span class="driver-name">{{ assignment.driver.name | short_name }}</span>
                    {% elif assignment and not assignment.driver %}
                        <span class="text-warning">—</span>
                    {% else %}
                        <span class="text-muted">Free</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if not is_historical %}
{# Driver-only assignments (not assigned to any van) #}
{% set has_driver_only = namespace(val=false) %}
{% for day in days %}
{% set day_iso = day.isoformat() %}
{% if driver_only_by_date[day_iso] | length > 0 %}
    {% set has_driver_only.val = true %}
{% endif %}
{% endfor %}

{% if has_driver_only.val %}
<div class="card mt-3">
    <div class="card-header bg-warning bg-opacity-25 d-flex align-items-center justify-content-between">
        <span><i class="bi bi-person-exclamation"></i> <strong>Drivers without van</strong></span>
        {% if can_edit %}
        <span class="d-flex align-items-center gap-2">
            <label class="form-check-label me-1" style="font-size:0.78rem;">
                <input type="checkbox" class="form-check-input" onchange="toggleAllDriverOnly(this)"> Select All
            </label>
            <button id="btn-remove-driveronly" class="btn btn-danger btn-sm py-0 px-2" style="display:none; font-size:0.75rem;" onclick="removeSelectedDriverOnly()">
                <i class="bi bi-trash"></i> Remove Selected
            </button>
        </span>
        {% endif %}
    </div>
    <div class="card-body p-2 driveronly-scroll">
        <div class="driveronly-grid">
            <div class="driveronly-spacer"></div>
            {% for day in days %}
            {% set day_iso = day.isoformat() %}
            {% set unassigned = driver_only_by_date[day_iso] %}
            <div class="driveronly-day-col">
                <small class="fw-bold">{{ day.strftime('%a %d/%m') }}</small>
                {% for a in unassigned %}
                <div class="assignment-chip chip-unpaired mb-1 d-flex align-items-center gap-1" data-driveronly-id="{{ a.id }}" data-driveronly-driver-id="{{ a.driver_id }}" data-driveronly-date="{{ day_iso }}">
                    {% if can_edit %}
                    <input type="checkbox" class="form-check-input driveronly-checkbox" value="{{ a.id }}" onchange="updateRemoveDriverOnlyBtn()" style="margin:0; flex-shrink:0;">
                    {% endif %}
                    <small class="flex-grow-1">
                        <i class="bi bi-person"></i>
                        {{ a.driver.name | short_name }}
                    </small>
                    {% if can_edit %}
                    <button class="btn btn-outline-secondary btn-sm py-0 px-1 driveronly-pair-btn" title="Assign van" style="font-size:0.65rem; line-height:1;">
                        <i class="bi bi-truck"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm py-0 px-1 driveronly-delete-btn" title="Remove" style="font-size:0.65rem; line-height:1;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
                {% if not unassigned %}
                <small class="text-muted">—</small>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{# Van pairing dropdown (for driver-only assignments) #}
{% if can_edit %}
<div id="vanPairDropdown" class="cell-autocomplete-dropdown" style="display:none;">
    <input type="text" id="vanPairSearchInput" class="form-control form-control-sm" placeholder="Search van...">
    <div id="vanPairList" class="cell-driver-list"></div>
    <hr class="my-1">
    <div class="d-flex gap-1 p-1">
        <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" id="vanPairCancelBtn">
            <i class="bi bi-escape"></i> Cancel
        </button>
    </div>
</div>
{% endif %}
{% endif %}

{% if can_edit %}
<div class="modal fade" id="uploadDriversModal" tabindex="-1" aria-labelledby="uploadDriversModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadDriversModalLabel"><i class="bi bi-upload"></i> Upload Drivers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="uploadDay" class="form-label">Day</label>
                    <select id="uploadDay" class="form-select">
                        {% for day in days %}
                        <option value="{{ day.isoformat() }}" {% if day == today %}selected{% endif %}>
                            {{ day.strftime('%A %d/%m/%Y') }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="uploadFile" class="form-label">Driver list file</label>
                    <input type="file" id="uploadFile" class="form-control" accept=".xlsx,.csv">
                </div>
                <div id="uploadAlert" style="display:none;"></div>
                <table id="uploadUnrecognized" class="table table-sm table-bordered mt-2" style="display:none;">
                    <thead class="table-warning">
                        <tr><th>Unrecognized Names</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="uploadSubmitBtn">
                    <i class="bi bi-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}{# end not is_historical #}

{% endblock %}

{% block scripts %}
{% if can_edit and not is_historical %}
<script>
(function() {
    let activeCell = null;
    let savedContent = '';
    let searchTimeout = null;

    // Click on editable cell → open inline editor
    document.querySelectorAll('.cell-editable').forEach(cell => {
        cell.addEventListener('click', function(e) {
            e.stopPropagation();
            openEditor(this);
        });
    });

    function openEditor(cell) {
        // If clicking same cell, close it
        if (activeCell === cell) { closeEditor(); return; }
        // Close any existing editor first
        if (activeCell) closeEditor();

        activeCell = cell;
        savedContent = cell.innerHTML;

        // Add editing class (makes cell position:relative, overflow:visible)
        cell.classList.add('cell-editing');

        // Build inline dropdown inside the cell
        const dd = document.createElement('div');
        dd.className = 'cell-inline-dropdown';
        dd.addEventListener('click', e => e.stopPropagation());

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Search driver...';
        dd.appendChild(input);

        const list = document.createElement('div');
        list.className = 'cell-inline-list';
        dd.appendChild(list);

        const actions = document.createElement('div');
        actions.className = 'cell-inline-actions';

        const clearBtn = document.createElement('button');
        clearBtn.className = 'btn btn-outline-danger btn-sm py-0 flex-fill';
        clearBtn.style.fontSize = '0.75rem';
        clearBtn.innerHTML = '<i class="bi bi-x-lg"></i> Clear';
        clearBtn.addEventListener('click', () => clearAssignment());
        actions.appendChild(clearBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-outline-secondary btn-sm py-0';
        cancelBtn.style.fontSize = '0.75rem';
        cancelBtn.innerHTML = '<i class="bi bi-escape"></i>';
        cancelBtn.addEventListener('click', () => closeEditor());
        actions.appendChild(cancelBtn);

        dd.appendChild(actions);
        cell.appendChild(dd);

        // Focus input without scrolling
        input.focus({ preventScroll: true });

        // Load drivers immediately
        loadDrivers(input, list, '');

        let cellActiveIndex = -1;

        // Search on type
        input.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            cellActiveIndex = -1;
            searchTimeout = setTimeout(() => loadDrivers(input, list, this.value), 200);
        });

        function updateCellActiveItem() {
            const items = list.querySelectorAll('.cell-inline-item');
            items.forEach((item, i) => {
                item.classList.toggle('active', i === cellActiveIndex);
                if (i === cellActiveIndex) item.scrollIntoView({ block: 'nearest' });
            });
        }

        input.addEventListener('keydown', function(e) {
            const items = list.querySelectorAll('.cell-inline-item');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                cellActiveIndex = Math.min(cellActiveIndex + 1, items.length - 1);
                updateCellActiveItem();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                cellActiveIndex = Math.max(cellActiveIndex - 1, 0);
                updateCellActiveItem();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (items.length > 0) {
                    const idx = cellActiveIndex >= 0 ? cellActiveIndex : 0;
                    if (items[idx]) items[idx].click();
                }
            } else if (e.key === 'Escape') {
                closeEditor();
            }
        });
    }

    function closeEditor() {
        if (!activeCell) return;
        // Remove the dropdown, restore cell content
        const dd = activeCell.querySelector('.cell-inline-dropdown');
        if (dd) dd.remove();
        activeCell.classList.remove('cell-editing');
        activeCell = null;
        savedContent = '';
    }

    // Close editor on click outside
    document.addEventListener('click', function() {
        if (activeCell) closeEditor();
    });

    async function clearAssignment() {
        if (!activeCell) return;
        const assignmentId = activeCell.dataset.assignmentId;
        if (!assignmentId) { closeEditor(); return; }
        try {
            const res = await fetch(`/api/assignments/${assignmentId}`, { method: 'DELETE' });
            if (res.ok) {
                const dd = activeCell.querySelector('.cell-inline-dropdown');
                if (dd) dd.remove();
                activeCell.classList.remove('cell-editing');
                activeCell.innerHTML = '<span class="text-muted">Free</span>';
                delete activeCell.dataset.assignmentId;
                delete activeCell.dataset.driverId;
                delete activeCell.dataset.driverName;
                activeCell = null;
            } else {
                const err = await res.json();
                alert(err.detail || 'Error removing assignment');
            }
        } catch (e) { alert('Network error'); }
    }

    async function setVOR() {
        if (!activeCell) return;
        const vanId = parseInt(activeCell.dataset.vanId);
        const dateVal = activeCell.dataset.date;
        const cellAssignmentId = activeCell.dataset.assignmentId;

        try {
            let res;
            if (cellAssignmentId) {
                // Update existing: set driver to null (van-only = VOR)
                res = await fetch(`/api/assignments/${cellAssignmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assignment_date: dateVal, van_id: vanId, driver_id: null, notes: 'VOR' })
                });
            } else {
                // Create new van-only assignment
                res = await fetch('/api/assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assignment_date: dateVal, van_id: vanId, driver_id: null, notes: 'VOR' })
                });
            }
            if (res.ok) {
                const data = await res.json();
                const dd = activeCell.querySelector('.cell-inline-dropdown');
                if (dd) dd.remove();
                activeCell.classList.remove('cell-editing');
                activeCell.innerHTML = '<span class="text-danger fw-bold">VOR</span>';
                activeCell.dataset.assignmentId = data.id;
                delete activeCell.dataset.driverId;
                delete activeCell.dataset.driverName;
                activeCell = null;
            } else {
                const err = await res.json();
                alert(err.detail || 'Error setting VOR');
            }
        } catch (e) { alert('Network error'); }
    }

    async function removeDriverFromAssignment() {
        if (!activeCell) return;
        const cellAssignmentId = activeCell.dataset.assignmentId;
        if (!cellAssignmentId) { closeEditor(); return; }

        const vanId = parseInt(activeCell.dataset.vanId);
        const dateVal = activeCell.dataset.date;

        try {
            // Update assignment: keep van, remove driver
            const res = await fetch(`/api/assignments/${cellAssignmentId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ assignment_date: dateVal, van_id: vanId, driver_id: null, notes: null })
            });
            if (res.ok) {
                const data = await res.json();
                const dd = activeCell.querySelector('.cell-inline-dropdown');
                if (dd) dd.remove();
                activeCell.classList.remove('cell-editing');
                activeCell.innerHTML = '<span class="text-warning">—</span>';
                activeCell.dataset.assignmentId = data.id;
                delete activeCell.dataset.driverId;
                delete activeCell.dataset.driverName;
                activeCell = null;
            } else {
                const err = await res.json();
                alert(err.detail || 'Error removing driver');
            }
        } catch (e) { alert('Network error'); }
    }

    async function loadDrivers(input, list, query) {
        if (!activeCell) return;
        const dateVal = activeCell.dataset.date;
        try {
            const res = await fetch(`/api/assignments/assignable-drivers-for-van?assignment_date=${dateVal}&q=${encodeURIComponent(query)}`);
            const drivers = await res.json();
            list.innerHTML = '';

            // Add special options at the top (only when not filtering by search)
            if (!query) {
                const hasAssignment = !!activeCell.dataset.assignmentId;

                // "Free" option - clear assignment (make cell free)
                const freeItem = document.createElement('div');
                freeItem.className = 'cell-inline-item';
                freeItem.style.cssText = 'color:#198754; font-weight:600; border-bottom:1px solid #dee2e6;';
                freeItem.innerHTML = '<i class="bi bi-check-circle"></i> Free';
                freeItem.addEventListener('click', () => clearAssignment());
                list.appendChild(freeItem);

                // "VOR" option - mark van as out of service for this day (van-only, no driver)
                const vorItem = document.createElement('div');
                vorItem.className = 'cell-inline-item';
                vorItem.style.cssText = 'color:#dc3545; font-weight:600; border-bottom:1px solid #dee2e6;';
                vorItem.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> VOR';
                vorItem.addEventListener('click', () => setVOR());
                list.appendChild(vorItem);

                // "Remove driver" option - remove driver but keep van assignment
                if (hasAssignment && activeCell.dataset.driverId) {
                    const removeItem = document.createElement('div');
                    removeItem.className = 'cell-inline-item';
                    removeItem.style.cssText = 'color:#6c757d; font-weight:600; border-bottom:1px solid #dee2e6;';
                    removeItem.innerHTML = '<i class="bi bi-person-x"></i> Remove driver';
                    removeItem.addEventListener('click', () => removeDriverFromAssignment());
                    list.appendChild(removeItem);
                }
            }

            if (drivers.length === 0 && query) {
                list.innerHTML += '<div class="p-2 text-muted" style="font-size:0.78rem">No drivers found</div>';
                return;
            }
            drivers.forEach(d => {
                const item = document.createElement('div');
                item.className = 'cell-inline-item';
                if (d.existing_assignment_id) {
                    item.innerHTML = `${d.short_name} <span class="badge bg-warning text-dark" style="font-size:0.55rem">awaiting van</span>`;
                } else {
                    item.textContent = d.short_name;
                }
                item.addEventListener('click', () => selectDriver(d));
                list.appendChild(item);
            });
        } catch (e) {
            list.innerHTML = '<div class="p-2 text-danger" style="font-size:0.78rem">Error loading</div>';
        }
    }

    async function selectDriver(driver) {
        if (!activeCell) return;
        const vanId = parseInt(activeCell.dataset.vanId);
        const dateVal = activeCell.dataset.date;
        const cellAssignmentId = activeCell.dataset.assignmentId;

        try {
            let res;
            if (cellAssignmentId) {
                res = await fetch(`/api/assignments/${cellAssignmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assignment_date: dateVal, van_id: vanId, driver_id: driver.id, notes: null })
                });
            } else if (driver.existing_assignment_id) {
                res = await fetch(`/api/assignments/${driver.existing_assignment_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assignment_date: dateVal, van_id: vanId, driver_id: driver.id, notes: null })
                });
            } else {
                res = await fetch('/api/assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assignment_date: dateVal, van_id: vanId, driver_id: driver.id, notes: null })
                });
            }

            if (res.ok) {
                const data = await res.json();
                // Remove dropdown, update cell
                const dd = activeCell.querySelector('.cell-inline-dropdown');
                if (dd) dd.remove();
                activeCell.classList.remove('cell-editing');
                activeCell.innerHTML = `<span class="driver-name">${driver.short_name}</span>`;
                activeCell.dataset.assignmentId = data.id;
                activeCell.dataset.driverId = driver.id;
                activeCell.dataset.driverName = driver.short_name;
                // Remove from driver-only section if they were there
                if (driver.existing_assignment_id) {
                    const chip = document.querySelector(`[data-driveronly-id="${driver.existing_assignment_id}"]`);
                    if (chip) chip.remove();
                }
                activeCell = null;
            } else {
                const err = await res.json();
                alert(err.detail || 'Error assigning driver');
            }
        } catch (e) { alert('Network error'); }
    }

    // --- Driver-only: delete ---
    document.querySelectorAll('.driveronly-delete-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const chip = this.closest('[data-driveronly-id]');
            const id = chip.dataset.driveronlyId;
            if (!confirm('Remove this driver assignment?')) return;
            try {
                const res = await fetch(`/api/assignments/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    chip.remove();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'Error removing');
                }
            } catch (e) { alert('Network error'); }
        });
    });

    // --- Driver-only: pair with van ---
    const vanDropdown = document.getElementById('vanPairDropdown');
    const vanSearchInput = document.getElementById('vanPairSearchInput');
    const vanPairList = document.getElementById('vanPairList');
    const vanPairCancelBtn = document.getElementById('vanPairCancelBtn');
    let activePairChip = null;
    let vanSearchTimeout = null;

    if (vanDropdown) {
        document.querySelectorAll('.driveronly-pair-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const chip = this.closest('[data-driveronly-id]');
                if (activePairChip === chip && vanDropdown.style.display !== 'none') {
                    closeVanDropdown();
                    return;
                }
                activePairChip = chip;

                const rect = this.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                vanDropdown.style.display = 'block';
                vanDropdown.style.left = rect.left + 'px';
                vanDropdown.style.width = '240px';
                if (spaceBelow >= 280) {
                    vanDropdown.style.top = rect.bottom + 'px';
                    vanDropdown.style.bottom = 'auto';
                } else {
                    vanDropdown.style.bottom = (window.innerHeight - rect.top) + 'px';
                    vanDropdown.style.top = 'auto';
                }

                vanSearchInput.value = '';
                vanSearchInput.focus({ preventScroll: true });
                loadVans('');
            });
        });

        function closeVanDropdown() {
            vanDropdown.style.display = 'none';
            activePairChip = null;
            vanPairList.innerHTML = '';
        }

        vanPairCancelBtn.addEventListener('click', closeVanDropdown);

        document.addEventListener('click', function(e) {
            if (vanDropdown.style.display !== 'none' && !vanDropdown.contains(e.target)) {
                closeVanDropdown();
            }
        });

        vanDropdown.addEventListener('click', function(e) { e.stopPropagation(); });

        let vanActiveIndex = -1;

        vanSearchInput.addEventListener('input', function() {
            clearTimeout(vanSearchTimeout);
            vanActiveIndex = -1;
            vanSearchTimeout = setTimeout(() => loadVans(this.value), 200);
        });

        function updateVanActiveItem() {
            const items = vanPairList.querySelectorAll('.cell-driver-item');
            items.forEach((item, i) => {
                item.classList.toggle('active', i === vanActiveIndex);
                if (i === vanActiveIndex) item.scrollIntoView({ block: 'nearest' });
            });
        }

        vanSearchInput.addEventListener('keydown', function(e) {
            const items = vanPairList.querySelectorAll('.cell-driver-item');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                vanActiveIndex = Math.min(vanActiveIndex + 1, items.length - 1);
                updateVanActiveItem();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                vanActiveIndex = Math.max(vanActiveIndex - 1, 0);
                updateVanActiveItem();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (items.length > 0) {
                    const idx = vanActiveIndex >= 0 ? vanActiveIndex : 0;
                    if (items[idx]) items[idx].click();
                }
            } else if (e.key === 'Escape') {
                closeVanDropdown();
            }
        });

        async function loadVans(query) {
            if (!activePairChip) return;
            const dateVal = activePairChip.dataset.driveronlyDate;
            try {
                const res = await fetch(`/api/assignments/available-vans?assignment_date=${dateVal}&q=${encodeURIComponent(query)}`);
                const vans = await res.json();
                vanPairList.innerHTML = '';
                if (vans.length === 0) {
                    vanPairList.innerHTML = '<div class="p-2 text-muted small">No vans available</div>';
                    return;
                }
                vans.forEach(v => {
                    const item = document.createElement('div');
                    item.className = 'cell-driver-item';
                    let label = v.code;
                    if (v.description) label += ` - ${v.description}`;
                    if (v.operational_status === 'GROUNDED') {
                        item.innerHTML = `${label} <span class="badge bg-danger" style="font-size:0.6rem">VOR</span>`;
                    } else {
                        item.textContent = label;
                    }
                    item.addEventListener('click', () => pairWithVan(v));
                    vanPairList.appendChild(item);
                });
            } catch (e) {
                vanPairList.innerHTML = '<div class="p-2 text-danger small">Error loading vans</div>';
            }
        }

        async function pairWithVan(van) {
            if (!activePairChip) return;
            const id = activePairChip.dataset.driveronlyId;
            const driverId = parseInt(activePairChip.dataset.driveronlyDriverId);
            const dateVal = activePairChip.dataset.driveronlyDate;
            try {
                const res = await fetch(`/api/assignments/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assignment_date: dateVal,
                        van_id: van.id,
                        driver_id: driverId,
                        notes: null
                    })
                });
                if (res.ok) {
                    closeVanDropdown();
                    window.location.reload();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'Error pairing van');
                }
            } catch (e) { alert('Network error'); }
        }
    }
})();

// --- Van column: VOR toggle ---
(function() {
    let activeVanCell = null;
    let activeVanDropdown = null;

    function closeVanStatusDropdown() {
        if (activeVanDropdown) {
            activeVanDropdown.remove();
            activeVanDropdown = null;
        }
        if (activeVanCell) {
            activeVanCell.classList.remove('cell-editing');
            activeVanCell = null;
        }
    }

    document.addEventListener('click', function() {
        closeVanStatusDropdown();
    });

    document.querySelectorAll('.van-code-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.stopPropagation();
            const cell = this.closest('.cell-van');
            const vanId = cell.dataset.vanId;
            const status = cell.dataset.vanStatus;

            // If already open on this cell, close it
            if (activeVanCell === cell) {
                closeVanStatusDropdown();
                return;
            }
            closeVanStatusDropdown();

            // Add cell-editing class for overflow:visible + position:relative
            cell.classList.add('cell-editing');
            activeVanCell = cell;

            const dd = document.createElement('div');
            dd.className = 'cell-inline-dropdown';
            dd.style.minWidth = '160px';
            dd.addEventListener('click', e => e.stopPropagation());

            const item = document.createElement('div');
            item.className = 'cell-inline-item';
            item.style.fontWeight = '600';
            item.style.padding = '6px 8px';
            item.style.cursor = 'pointer';

            if (status === 'GROUNDED') {
                item.style.color = '#198754';
                item.innerHTML = '<i class="bi bi-check-circle-fill"></i> Mark Operational';
                item.addEventListener('click', () => toggleVanStatus(vanId, 'OPERATIONAL'));
            } else {
                item.style.color = '#dc3545';
                item.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Mark VOR';
                item.addEventListener('click', () => toggleVanStatus(vanId, 'GROUNDED'));
            }
            dd.appendChild(item);

            cell.appendChild(dd);
            activeVanDropdown = dd;
        });
    });

    async function toggleVanStatus(vanId, newStatus) {
        try {
            const res = await fetch(`/api/vans/${vanId}/operational-status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ operational_status: newStatus })
            });
            if (res.ok) {
                window.location.reload();
            } else {
                const err = await res.json();
                alert(err.detail || 'Error updating van status');
            }
        } catch (e) {
            alert('Network error');
        }
    }
})();

// --- Preassign column: inline driver editor ---
(function() {
    let activePreassignCell = null;
    let activePreassignDropdown = null;
    let preassignSearchTimeout = null;

    function closePreassignDropdown() {
        if (activePreassignDropdown) {
            activePreassignDropdown.remove();
            activePreassignDropdown = null;
        }
        if (activePreassignCell) {
            activePreassignCell.classList.remove('cell-editing');
            activePreassignCell = null;
        }
    }

    document.addEventListener('click', function() {
        closePreassignDropdown();
    });

    document.querySelectorAll('.preassign-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.stopPropagation();
            const cell = this.closest('.cell-preassign');

            if (activePreassignCell === cell) {
                closePreassignDropdown();
                return;
            }
            closePreassignDropdown();

            activePreassignCell = cell;
            cell.classList.add('cell-editing');

            const dd = document.createElement('div');
            dd.className = 'cell-inline-dropdown';
            dd.style.minWidth = '200px';
            dd.addEventListener('click', e => e.stopPropagation());

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Search driver...';
            dd.appendChild(input);

            const list = document.createElement('div');
            list.className = 'cell-inline-list';
            dd.appendChild(list);

            const actions = document.createElement('div');
            actions.className = 'cell-inline-actions';

            if (cell.dataset.preassignId) {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn btn-outline-danger btn-sm py-0 flex-fill';
                clearBtn.style.fontSize = '0.75rem';
                clearBtn.innerHTML = '<i class="bi bi-x-lg"></i> Clear';
                clearBtn.addEventListener('click', () => clearPreassignment());
                actions.appendChild(clearBtn);
            }

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-outline-secondary btn-sm py-0';
            cancelBtn.style.fontSize = '0.75rem';
            cancelBtn.innerHTML = '<i class="bi bi-escape"></i>';
            cancelBtn.addEventListener('click', () => closePreassignDropdown());
            actions.appendChild(cancelBtn);

            dd.appendChild(actions);
            cell.appendChild(dd);
            activePreassignDropdown = dd;

            input.focus({ preventScroll: true });
            loadPreassignDrivers(list, '');

            let paActiveIndex = -1;

            input.addEventListener('input', function() {
                clearTimeout(preassignSearchTimeout);
                paActiveIndex = -1;
                preassignSearchTimeout = setTimeout(() => loadPreassignDrivers(list, this.value), 200);
            });

            function updatePaActiveItem() {
                const items = list.querySelectorAll('.cell-inline-item');
                items.forEach((item, i) => {
                    item.classList.toggle('active', i === paActiveIndex);
                    if (i === paActiveIndex) item.scrollIntoView({ block: 'nearest' });
                });
            }

            input.addEventListener('keydown', function(e) {
                const items = list.querySelectorAll('.cell-inline-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    paActiveIndex = Math.min(paActiveIndex + 1, items.length - 1);
                    updatePaActiveItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    paActiveIndex = Math.max(paActiveIndex - 1, 0);
                    updatePaActiveItem();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (items.length > 0) {
                        const idx = paActiveIndex >= 0 ? paActiveIndex : 0;
                        if (items[idx]) items[idx].click();
                    }
                } else if (e.key === 'Escape') {
                    closePreassignDropdown();
                }
            });
        });
    });

    async function loadPreassignDrivers(list, query) {
        if (!activePreassignCell) return;
        try {
            const res = await fetch(`/api/drivers/search?q=${encodeURIComponent(query)}`);
            const drivers = await res.json();
            list.innerHTML = '';
            if (drivers.length === 0) {
                list.innerHTML = '<div class="p-2 text-muted" style="font-size:0.78rem">No drivers found</div>';
                return;
            }
            drivers.forEach(d => {
                const item = document.createElement('div');
                item.className = 'cell-inline-item';
                const shortName = d.name.split('•')[0].trim().split(/\s+/);
                const display = shortName.length <= 2 ? shortName.join(' ') : shortName[0] + ' ' + shortName[shortName.length - 1];
                item.textContent = display;
                item.addEventListener('click', () => selectPreassignDriver(d.id, display));
                list.appendChild(item);
            });
        } catch (e) {
            list.innerHTML = '<div class="p-2 text-danger" style="font-size:0.78rem">Error loading</div>';
        }
    }

    async function selectPreassignDriver(driverId, displayName) {
        if (!activePreassignCell) return;
        const vanId = parseInt(activePreassignCell.dataset.vanId);
        try {
            const res = await fetch('/api/preassignments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ driver_id: driverId, van_id: vanId })
            });
            if (res.ok) {
                window.location.reload();
            } else {
                const err = await res.json();
                alert(err.detail || 'Error setting preassignment');
            }
        } catch (e) { alert('Network error'); }
    }

    async function clearPreassignment() {
        if (!activePreassignCell) return;
        const preassignId = activePreassignCell.dataset.preassignId;
        if (!preassignId) { closePreassignDropdown(); return; }
        try {
            const res = await fetch(`/api/preassignments/${preassignId}`, { method: 'DELETE' });
            if (res.ok) {
                window.location.reload();
            } else {
                const err = await res.json();
                alert(err.detail || 'Error clearing preassignment');
            }
        } catch (e) { alert('Network error'); }
    }
})();

// --- Grid: multi-select delete ---
function toggleAllGrid(source) {
    document.querySelectorAll('.grid-checkbox').forEach(cb => { cb.checked = source.checked; });
    updateRemoveGridBtn();
}

function updateRemoveGridBtn() {
    const btn = document.getElementById('btn-remove-grid');
    if (!btn) return;
    const checked = document.querySelectorAll('.grid-checkbox:checked').length;
    btn.style.display = checked > 0 ? 'inline-block' : 'none';
    btn.innerHTML = `<i class="bi bi-trash"></i> Remove Selected (${checked})`;
}

async function removeSelectedGrid() {
    const ids = Array.from(document.querySelectorAll('.grid-checkbox:checked')).map(cb => parseInt(cb.value));
    if (ids.length === 0) return;
    if (!confirm(`Remove ${ids.length} selected assignment(s)?`)) return;
    try {
        const results = await Promise.all(ids.map(id =>
            fetch(`/api/assignments/${id}`, { method: 'DELETE' })
        ));
        const unauthorized = results.find(r => r.status === 401);
        if (unauthorized) { window.location.href = '/login'; return; }
        const forbidden = results.find(r => r.status === 403);
        if (forbidden) { alert('Permission denied.'); return; }
        const failed = results.filter(r => !r.ok);
        if (failed.length > 0) {
            alert(`${ids.length - failed.length} removed, ${failed.length} failed.`);
        }
        window.location.reload();
    } catch (err) {
        alert('Network error: ' + err.message);
    }
}

// --- Driver-only: multi-select delete ---
function toggleAllDriverOnly(source) {
    document.querySelectorAll('.driveronly-checkbox').forEach(cb => { cb.checked = source.checked; });
    updateRemoveDriverOnlyBtn();
}

function updateRemoveDriverOnlyBtn() {
    const btn = document.getElementById('btn-remove-driveronly');
    if (!btn) return;
    const checked = document.querySelectorAll('.driveronly-checkbox:checked').length;
    btn.style.display = checked > 0 ? 'inline-block' : 'none';
    btn.innerHTML = `<i class="bi bi-trash"></i> Remove Selected (${checked})`;
}

async function removeSelectedDriverOnly() {
    const ids = Array.from(document.querySelectorAll('.driveronly-checkbox:checked')).map(cb => parseInt(cb.value));
    if (ids.length === 0) return;
    if (!confirm(`Remove ${ids.length} selected driver assignment(s)?`)) return;
    try {
        const results = await Promise.all(ids.map(id =>
            fetch(`/api/assignments/${id}`, { method: 'DELETE' })
        ));
        const unauthorized = results.find(r => r.status === 401);
        if (unauthorized) { window.location.href = '/login'; return; }
        const forbidden = results.find(r => r.status === 403);
        if (forbidden) { alert('Permission denied.'); return; }
        const failed = results.filter(r => !r.ok);
        if (failed.length > 0) {
            alert(`${ids.length - failed.length} removed, ${failed.length} failed.`);
        }
        window.location.reload();
    } catch (err) {
        alert('Network error: ' + err.message);
    }
}

// --- Upload Drivers modal handler ---
(function() {
    const submitBtn = document.getElementById('uploadSubmitBtn');
    const fileInput = document.getElementById('uploadFile');
    const daySelect = document.getElementById('uploadDay');
    const alertDiv = document.getElementById('uploadAlert');
    const unrecTable = document.getElementById('uploadUnrecognized');

    function showAlert(msg, type) {
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = msg;
        alertDiv.style.display = 'block';
    }

    function resetModal() {
        alertDiv.style.display = 'none';
        unrecTable.style.display = 'none';
        unrecTable.querySelector('tbody').innerHTML = '';
    }

    document.getElementById('uploadDriversModal').addEventListener('show.bs.modal', resetModal);

    submitBtn.addEventListener('click', async function() {
        resetModal();
        const file = fileInput.files[0];
        if (!file) {
            showAlert('Please select a file.', 'warning');
            return;
        }
        const date = daySelect.value;
        const formData = new FormData();
        formData.append('file', file);

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';

        try {
            const res = await fetch(`/api/assignments/bulk-upload-drivers?assignment_date=${date}`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (res.ok) {
                const count = data.assignments_created || 0;
                showAlert(`Upload successful! ${count} driver(s) assigned.`, 'success');
                const notFound = (data.import_result && data.import_result.not_found) || [];
                if (notFound.length > 0) {
                    const tbody = unrecTable.querySelector('tbody');
                    notFound.forEach(name => {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.textContent = name;
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                    });
                    unrecTable.style.display = 'table';
                }
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showAlert(data.detail || 'Upload failed.', 'danger');
            }
        } catch (e) {
            showAlert('Network error.', 'danger');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-upload"></i> Upload';
        }
    });
})();
</script>
{% endif %}
{% endblock %}
